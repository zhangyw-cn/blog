# 性能指标

## 术语

- `使用率`: 有两种维度使用率的定义: 时间维度和容量维度. 
  - `时间使用率`是组件的工作时间占比. 如果使用率是100%, 只能说有可能出现资源竞争导致性能下载, 但并不一定. 因为尽管使用率是100%, 但是仍有可能接收更多个工作. 比如SSD磁盘具有并行处理的能力; 
  - `容量使用率`是某个系统容量的使用比例. 比如一个系统的吞吐使用了百分之几, 这时候使用率是100%时, 说明不能再接收更多工作, 性能将开始下降. 

## 处理器 (CPU)

### CPU中的一些概念:

- `jiffies`: 记录自系统启动以来经过的时钟中断次数。每个时钟中断周期被称为一个"滴答" (tick). 
- `CONFIG_HZ 或 HZ`: 是内核时钟的频率，用于内核的时间测量和调度。jiffies 的增加频率由内核的时钟中断频率 HZ 决定. 每经过`1/HZ`s, jiffies加1. HZ常见的值有100、250、1000等. 可以通过系统和CONFIG_HZ配置查看.
```shell
cat /boot/config-$(uname -r) | grep CONFIG_HZ
```
- `USER_HZ`: 是用户空间程序看到的时钟频率, 用于用户空间的时间测量, 通常固定为100, 不随 CONFIG_HZ 变化.
- `off-CPU`: 一个进程或线程不在CPU上执行的状态.当一个进程或线程被调度出CPU, 进入等待状态或被阻塞时, 它就被认为是"off-CPU". 例如等待磁盘和网络IO操作完成时, 等待锁时, 等待信号时, 

### /proc/stat

伪文件系统`/proc/stat`统计了自开机起来, CPU处于各个状态的统计值. 这个统计值是通过周期性地对cpu工作状态的抽样, 抽样频率为USER_HZ, 来观测cpu在不同状态的使用率. 例如

```shell
# cat /proc/stat
cpu  132815099 2328 135864489 5101336371 477021 0 156631 0 0 0
cpu0 66368537 1097 67901300 2550850054 320316 0 95878 0 0 0
cpu1 66446561 1230 67963189 2550486316 156704 0 60753 0 0 0
... 省略其他行 ...
```

cpu行是所有cpu的聚合值, cpu0和cpu1是每个cpu的统计值. 统计值的单位是ticks, 即从开启算起, 该CPU运行在该状态的ticks数量. 从左到右各项的含义如下:

- `(1) user`: CPU运行在 用户态(user mode), 且`nice<=0`.
- `(2) nice`: CPU运行在 用户态(user mode), 且`nice>0`.
- `(3) system`: CPU运行在 内核态(kernal mode), 且不在硬中断和软中断状态.
- `(4) idle`: CPU运行在空闲状态(既不是用户态, 也不是内核态), 且不在等待IO完成.
- `(5) iowait`: task在CPU空闲状态, 并且在等待IO完成. [iowait在CPU维度是没有含义的](https://docs.kernel.org/filesystems/proc.html#miscellaneous-kernel-statistics-in-proc-stat). 因为CPU如果因等待IO进入空闲状态, 就会允许其他task调度到该CPU运行.
- `(6) irq`: CPU运行在 内核态(kernal mode), 并正在处理 硬中断.
- `(7) softirq`: CPU运行在 内核态(kernal mode), 并正在处理 软中断.
- `(8) steal`: CPU需要运行时间, 但是宿主机没有提供的状态. 例如在虚拟机环境中, 但是由于宿主机超卖, CPU进入不自觉的等待状态.
- `(9) guest`: CPU在运行 `nice<=0` 的guest(例如虚拟机)的状态. 虚拟机中该值应该为0.
- `(10) guest_nice`: CPU在运行 nice>0 的guest(例如虚拟机)的状态. 虚拟机中该值应该为0.

CPU的空闲时会处于`idle`或`iowati`状态. CPU运行在用户态时,会处于`user`或`nice`状态. CPU运行在内核态时, 会处于`system`, `irq`或`softirq`状态.

### /proc/loadavg

loadavg统计了最近1分钟, 5分钟 和 15分钟的CPU负载情况. 这里的负载有点类似于容量使用率. 例如

```shell
# cat /proc/loadavg                                                                                              !124
0.02 0.10 0.13 1/207 19637
```

从左到右依次是:
- `(1) avg runnable process count in 1 minute`: 1分钟内可运行(runnable)的task数量平均值, 包括正在运行(running), 位于准备运行队列中(ready queue), 以及处于不可中断睡眠状态的(uninterruptible sleep state, TASK_UNINTERRUPTIBLE).
- `(2) avg runnable process count in 5 minute`: 5分钟内可运行(runnable)的task数量平均值, 包括正在运行(running), 位于准备运行队列中(ready queue), 以及处于不可中断睡眠状态的(uninterruptible sleep state, TASK_UNINTERRUPTIBLE).
- `(3) avg runnable process count in 15 minute`: 15分钟内可运行(runnable)的task数量平均值, 包括正在运行(running), 位于准备运行队列中(ready queue), 以及处于不可中断睡眠状态的(uninterruptible sleep state, TASK_UNINTERRUPTIBLE).
- `(4) number of processes currently runnable / total number of processes in system`: 以"/"分割的两个值, 当前可运行(runnable)的task数量 和 当前系统中的task数量.
- `(5) last pid created`: 最近创建的pid.


注: IO, 锁, 硬件中断等 都可能会让task处于TASK_UNINTERRUPTIBLE状态, 从而保护关键操作，防止它们被外部信号中断，从确保系统的稳定性和数据的完整性.

### top和iostat等程序

top和iostat等程序获取的CPU使用率是都是`时间使用率`. 通常也被称为`CPU Util`. 都是根据`/proc/stat`中的值计算出来的.


### 参考
- [CPU load](https://docs.kernel.org/admin-guide/cpu-load.html)
- [Linux 中 CPU 利用率是如何算出来的？](https://m.17golang.com/article/177721.html)
- [Miscellaneous kernel statistics in /proc/stat](https://docs.kernel.org/filesystems/proc.html#miscellaneous-kernel-statistics-in-proc-stat)
- [Steal Time Accounting](https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/virtualization_deployment_and_administration_guide/sect-kvm_guest_timing_management-steal_time_accounting)
- [Linux Load Averages: Solving the Mystery](https://brendangregg.com/blog/2017-08-08/linux-load-averages.html)

## 内容 (Memory)

## 磁盘 (Disk)